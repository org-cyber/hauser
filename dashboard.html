<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Agent Dashboard - Hauser NG</title>

<!-- Firebase Scripts -->
<script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>

<style>
:root {
  --primary: #0f172a;
  --primary-dark: #0a1120;
  --primary-light: #1e293b;
  --accent: #f97316;
  --accent-dark: #ea580c;
  --accent-light: #fb923c;
  --text-primary: #f1f5f9;
  --text-secondary: #cbd5e1;
  --text-muted: #94a3b8;
  --bg-primary: #0f172a;
  --bg-secondary: #1e293b;
  --border: #334155;
  --error: #ef4444;
  --success: #22c55e;
  --warning: #f59e0b;
  --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.25);
  --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
  --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
  --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.35), 0 10px 10px -5px rgba(0, 0, 0, 0.15);
  --radius-sm: 0.25rem;
  --radius: 0.5rem;
  --radius-lg: 0.75rem;
  --radius-xl: 1rem;
  --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
  background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
  color: var(--text-primary);
  min-height: 100vh;
  line-height: 1.5;
  position: relative;
  overflow-x: hidden;
}

body::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="15" cy="15" r="1.5" fill="%23cbd5e1" opacity="0.1"><animate attributeName="opacity" values="0.1;0.3;0.1" dur="4s" repeatCount="indefinite"/></circle><circle cx="85" cy="35" r="1" fill="%23cbd5e1" opacity="0.1"><animate attributeName="opacity" values="0.1;0.4;0.1" dur="5s" repeatCount="indefinite"/></circle><circle cx="45" cy="85" r="2" fill="%23cbd5e1" opacity="0.1"><animate attributeName="opacity" values="0.1;0.2;0.1" dur="6s" repeatCount="indefinite"/></circle></svg>');
  animation: float 20s ease-in-out infinite;
  pointer-events: none;
  z-index: -1;
}

@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-20px); }
}

/* Navbar Styles */
.navbar {
  background: linear-gradient(90deg, rgba(30, 41, 59, 0.95) 0%, rgba(15, 23, 42, 0.9) 100%);
  backdrop-filter: blur(12px);
  border-bottom: 1px solid var(--border);
  box-shadow: var(--shadow-lg);
  padding: 0.8rem 0;
  position: sticky;
  top: 0;
  z-index: 100;
}

.navbar-container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 1.5rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.logo-section {
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

.logo-icon {
  width: 48px;
  height: 48px;
  background: var(--accent);
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 4px 20px rgba(249, 115, 22, 0.3);
  font-size: 1.5rem;
}

.logo-text {
  font-size: 1.8rem;
  font-weight: bold;
  background: linear-gradient(to right, var(--text-primary), var(--accent-light));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.nav-links {
  display: flex;
  align-items: center;
  gap: 1.5rem;
}

.nav-link {
  color: var(--text-secondary);
  text-decoration: none;
  font-weight: 500;
  padding: 0.5rem 1rem;
  border-radius: var(--radius);
  transition: var(--transition);
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.nav-link:hover {
  color: var(--accent);
  background: rgba(255, 255, 255, 0.1);
}

.nav-link svg {
  width: 20px;
  height: 20px;
}

/* Main Content */
.main-container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 2rem 1.5rem;
}

.welcome-section {
  margin-bottom: 2rem;
  padding: 1.5rem;
  background: rgba(30, 41, 59, 0.5);
  border-radius: var(--radius-lg);
  backdrop-filter: blur(10px);
  border: 1px solid var(--border);
}

.welcome-title {
  font-size: 2.2rem;
  font-weight: bold;
  margin-bottom: 0.5rem;
  background: linear-gradient(to right, var(--text-primary), var(--accent));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.welcome-subtitle {
  font-size: 1.125rem;
  color: var(--text-secondary);
  opacity: 0.8;
  margin-bottom: 1rem;
}

.plan-warning {
  padding: 0.8rem;
  background: rgba(249, 115, 22, 0.15);
  border-left: 4px solid var(--accent);
  border-radius: var(--radius-sm);
  margin-top: 1rem;
}

.plan-warning p {
  color: var(--accent-light);
}

.dashboard-grid {
  display: grid;
  gap: 2rem;
  grid-template-columns: 1fr 2fr;
}

@media (max-width: 1024px) {
  .dashboard-grid {
    grid-template-columns: 1fr;
  }
}

/* Section Styles */
.section {
  background: linear-gradient(135deg, rgba(30, 41, 59, 0.7) 0%, rgba(15, 23, 42, 0.5) 100%);
  backdrop-filter: blur(10px);
  border: 1px solid var(--border);
  border-radius: var(--radius-xl);
  padding: 2rem;
  box-shadow: var(--shadow-md);
  transition: var(--transition);
}

.section:hover {
  box-shadow: var(--shadow-lg);
}

.section-header {
  display: flex;
  align-items: center;
  margin-bottom: 1.5rem;
}

.section-icon {
  width: 64px;
  height: 64px;
  background: var(--accent);
  border-radius: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-right: 1rem;
  box-shadow: 0 4px 20px rgba(249, 115, 22, 0.3);
  font-size: 1.5rem;
}

.section-title {
  font-size: 1.5rem;
  font-weight: bold;
  margin-bottom: 0.25rem;
}

.section-subtitle {
  color: var(--text-muted);
}

/* Profile Info Styles */
.profile-fields {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.profile-field {
  background: rgba(15, 23, 42, 0.5);
  padding: 1.2rem;
  border-radius: var(--radius-lg);
  border: 1px solid var(--border);
}

.profile-field.plan-field {
  background: linear-gradient(135deg, rgba(249, 115, 22, 0.2) 0%, rgba(15, 23, 42, 0.5) 100%);
  border: 1px solid var(--accent);
  animation: pulse 3s infinite;
}

@keyframes pulse {
  0% { box-shadow: 0 0 0 0 rgba(249, 115, 22, 0.2); }
  70% { box-shadow: 0 0 0 10px rgba(249, 115, 22, 0); }
  100% { box-shadow: 0 0 0 0 rgba(249, 115, 22, 0); }
}

.field-label {
  font-size: 0.875rem;
  font-weight: 500;
  color: var(--text-muted);
  margin-bottom: 0.25rem;
}

.plan-field .field-label {
  color: var(--accent-light);
}

.field-value {
  font-weight: 600;
  font-size: 1.1rem;
}

.plan-field .field-value {
  color: var(--accent-light);
  font-size: 1.25rem;
  font-weight: bold;
}

/* Listings Styles */
.property-grid {
  display: grid;
  gap: 1.5rem;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
}

.property-card {
  background: linear-gradient(135deg, rgba(30, 41, 59, 0.7) 0%, rgba(15, 23, 42, 0.5) 100%);
  backdrop-filter: blur(8px);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 1.5rem;
  box-shadow: var(--shadow-sm);
  transition: var(--transition);
  position: relative;
  overflow: hidden;
}

.property-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: var(--accent);
}

.property-card:hover {
  transform: translateY(-5px);
  box-shadow: var(--shadow);
  border-color: var(--accent);
}

.property-title {
  font-size: 1.25rem;
  font-weight: bold;
  margin-bottom: 0.5rem;
}

.property-price-location {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-bottom: 0.75rem;
  flex-wrap: wrap;
}

.property-price {
  font-size: 1.5rem;
  font-weight: bold;
  color: var(--accent);
}

.property-separator {
  color: var(--text-muted);
  opacity: 0.7;
}

.property-location {
  color: var(--text-secondary);
  font-weight: 500;
}

.property-description {
  color: var(--text-secondary);
  opacity: 0.8;
  font-size: 0.875rem;
  line-height: 1.5;
  margin-bottom: 1rem;
  display: -webkit-box;
  -webkit-line-clamp: 3;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.property-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding-top: 1rem;
  border-top: 1px solid var(--border);
}

.property-id {
  font-size: 0.75rem;
  color: var(--text-muted);
  opacity: 0.6;
}

.delete-btn {
  background: rgba(239, 68, 68, 0.2);
  color: var(--error);
  border: 1px solid var(--error);
  font-weight: 500;
  border-radius: var(--radius);
  padding: 0.5rem 1rem;
  cursor: pointer;
  transition: var(--transition);
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.delete-btn:hover {
  background: rgba(239, 68, 68, 0.3);
  transform: scale(1.05);
}

.delete-btn svg {
  width: 16px;
  height: 16px;
}

.empty-state {
  background: linear-gradient(135deg, rgba(30, 41, 59, 0.7) 0%, rgba(15, 23, 42, 0.5) 100%);
  backdrop-filter: blur(8px);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 2.5rem;
  text-align: center;
  grid-column: 1 / -1;
}

.empty-title {
  font-size: 1.125rem;
  margin-bottom: 0.5rem;
}

.empty-subtitle {
  color: var(--text-muted);
  opacity: 0.7;
  margin-bottom: 1.5rem;
}

.add-property-btn {
  background: rgba(249, 115, 22, 0.2);
  color: var(--accent);
  border: 1px solid var(--accent);
  border-radius: var(--radius);
  padding: 0.75rem 1.5rem;
  font-weight: 500;
  cursor: pointer;
  transition: var(--transition);
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
}

.add-property-btn:hover {
  background: rgba(249, 115, 22, 0.3);
  transform: translateY(-2px);
}

.add-property-btn svg {
  width: 20px;
  height: 20px;
}

/* Responsive Design */
@media (max-width: 768px) {
  .navbar-container {
    flex-direction: column;
    gap: 1rem;
    text-align: center;
  }

  .nav-links {
    flex-wrap: wrap;
    justify-content: center;
  }

  .welcome-title {
    font-size: 1.8rem;
  }

  .property-price-location {
    flex-direction: column;
    align-items: flex-start;
    gap: 0.25rem;
  }

  .property-footer {
    flex-direction: column;
    gap: 1rem;
    align-items: flex-start;
  }
  
  .section {
    padding: 1.5rem;
  }
}

@media (max-width: 480px) {
  .logo-text {
    font-size: 1.5rem;
  }
  
  .welcome-title {
    font-size: 1.5rem;
  }
  
  .section-icon {
    width: 48px;
    height: 48px;
    font-size: 1.2rem;
  }
  
  .section-title {
    font-size: 1.3rem;
  }
}

/* Utility classes */
.mt-1 { margin-top: 0.25rem; }
.mt-2 { margin-top: 0.5rem; }
.mt-3 { margin-top: 0.75rem; }
.mt-4 { margin-top: 1rem; }
.mb-1 { margin-bottom: 0.25rem; }
.mb-2 { margin-bottom: 0.5rem; }
.mb-3 { margin-bottom: 0.75rem; }
.mb-4 { margin-bottom: 1rem; }
</style>
</head>
<body>

<!-- Navbar -->
<header class="navbar">
  <div class="navbar-container">
    <div class="logo-section">
      <div class="logo-icon">üè°</div>
      <h1 class="logo-text">Hauser NG</h1>
    </div>
    <nav class="nav-links">
      <a href="login.html" class="nav-link">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
        </svg>
        Logout
      </a>
      <a href="add-property.html" id="addPropertyLink" class="nav-link" style="display: none;">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
        </svg>
        Add Property
      </a>
      <a href="real_estate_subscription.html" class="nav-link">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
        </svg>
        Upgrade Plan
      </a>
      <a href="vacancies.html" class="nav-link">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
        </svg>
        Vacancies
      </a>
      <a href="https://cust.fillout.com/eu" class="nav-link">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
        </svg>
        Feedback
      </a>
    </nav>
  </div>
</header>

<!-- Main Content -->
<main class="main-container">
  <!-- Welcome Section -->
  <div class="welcome-section">
    <h2 class="welcome-title">Welcome Back!</h2>
    <p class="welcome-subtitle">Manage your properties and track your success</p>
    <div class="plan-warning mt-3">
      <p>Free Users are only allowed one Vacancy post. Upgrade to premium for unlimited access</p>
    </div>
  </div>

  <div class="dashboard-grid">
    <!-- Profile Info -->
    <section class="section">
      <div class="section-header">
        <div class="section-icon">üë§</div>
        <div>
          <h3 class="section-title">Agent Profile</h3>
          <p class="section-subtitle">Your account details</p>
        </div>
      </div>
      
      <div class="profile-fields">
        <div class="profile-field">
          <div class="field-label">Name</div>
          <div class="field-value" id="profileName">Loading...</div>
        </div>
        
        <div class="profile-field">
          <div class="field-label">Email</div>
          <div class="field-value" id="profileEmail">Loading...</div>
        </div>
        
        <div class="profile-field">
          <div class="field-label">Role</div>
          <div class="field-value" id="profileRole">Loading...</div>
        </div>
        
        <div class="profile-field plan-field">
          <div class="field-label">Plan</div>
          <div class="field-value" id="profilePlan">Loading...</div>
        </div>
      </div>
    </section>

    <!-- Listings -->
    <section class="section">
      <div class="section-header">
        <div class="section-icon">üè†</div>
        <div>
          <h3 class="section-title">Property Listings</h3>
          <p class="section-subtitle">Your active properties</p>
        </div>
      </div>
      
      <div id="propertyList" class="property-grid"></div>
    </section>
  </div>
</main>

<!-- Scripts -->
<script>
  // Initialize Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyAHqg_u1DwWUB9l1vuoYDLKjCJl5Xx7Pbo",
    authDomain: "hauserng-77cc2.firebaseapp.com",
    projectId: "hauserng-77cc2",
    storageBucket: "hauserng-77cc2.appStorage.com",
    messagingSenderId: "613578175402",
    appId: "1:613578175402:web:db7413f898987ac6a1f1d3"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  let currentUserData = null;

  auth.onAuthStateChanged(user => {
    if (user) {
      const uid = user.uid;
      db.collection("users").doc(uid).get().then(doc => {
        if (doc.exists) {
          const data = doc.data();
          currentUserData = data;

          document.getElementById("profileName").textContent = data.name || "Unnamed";
          document.getElementById("profileEmail").textContent = data.email || "Unknown";
          document.getElementById("profileRole").textContent = data.role || "Not set";
          document.getElementById("profilePlan").textContent = data.plan || "free";

          checkAddPropertyPermission(data);
        }
      });
      loadListings(uid);
    } else {
      window.location.href = "login.html";
    }
  });

  function checkAddPropertyPermission(data) {
    const addLink = document.getElementById("addPropertyLink");
    const plan = data.plan || "free";
    const listingsCount = data.listingsCount || 0;

    if (!(plan === "free" && listingsCount >= 1)) {
      addLink.style.display = "flex";
    }
  }

  function loadListings(uid) {
    const list = document.getElementById('propertyList');
    list.innerHTML = '';
    db.collection('properties')
      .where('uid', '==', uid.trim())
      .get()
      .then(snapshot => {
        if (snapshot.empty) {
          list.innerHTML = `
            <div class="empty-state">
              <p class="empty-title">No properties listed yet.</p>
              <p class="empty-subtitle">Start by adding your first property!</p>
              <a href="add-property.html" class="add-property-btn mt-3">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                </svg>
                Add Your First Property
              </a>
            </div>
          `;
        } else {
          snapshot.forEach(doc => {
            const p = doc.data();
            const card = document.createElement('div');
            card.className = 'property-card';
            card.innerHTML = `
              <div class="property-title">${p.title || "Untitled"}</div>
              <div class="property-price-location">
                <span class="property-price">‚Ç¶${p.price || "N/A"}</span>
                <span class="property-separator">‚Ä¢</span>
                <span class="property-location">${p.location || "Unknown"}</span>
              </div>
              <p class="property-description">${p.description || "No description."}</p>
              <div class="property-footer">
                <div class="property-id">Property ID: ${doc.id.substring(0, 8)}...</div>
                <button class="delete-btn" data-id="${doc.id}">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                  </svg>
                  Delete
                </button>
              </div>
            `;

            card.querySelector('button').addEventListener('click', async () => {
              if (confirm('‚ö†Ô∏è Are you sure you want to delete this property?')) {
                try {
                  // 1. Delete the property
                  await db.collection('properties').doc(doc.id).delete();

                  // 2. If the user is on the "free" plan, check if they have 0 listings left
                  if (currentUserData.plan === "free") {
                    const remainingListings = await db.collection("properties")
                      .where("uid", "==", uid)
                      .get();

                    if (remainingListings.empty) {
                      await db.collection("users").doc(uid).update({
                        listingsCount: 0,
                        freeListingUsed: false   // üëà reset the flag here
                      });
                      console.log("‚úÖ listingsCount reset to 0 for free user.");
                    }
                  }

                  // 3. Reload listings
                  loadListings(uid);
                } catch (error) {
                  alert('‚ùå Failed to delete property.');
                  console.error(error);
                }
              }
            });

            list.appendChild(card);
          });
        }
      });
  }
</script>
</body>
</html>